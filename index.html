<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spanish Language Quiz Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-primary: #ef4444; /* Red 500 */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
        .container {
            max-width: 500px;
        }
        .level-button {
            transition: all 0.2s;
        }
        .answer-button {
            transition: all 0.15s;
            transform: scale(1);
        }
        .answer-button:active {
            transform: scale(0.98);
        }
        .correct {
            background-color: #10b981 !important; /* Emerald 500 */
            color: white !important;
            border-color: #059669 !important;
        }
        .incorrect {
            background-color: #f87171 !important; /* Red 400 */
            color: white !important;
            border-color: #ef4444 !important;
        }
        .listening {
            animation: pulse-red 1.5s infinite;
        }
        @keyframes pulse-red {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }
            50% {
                box-shadow: 0 0 0 15px rgba(239, 68, 68, 0);
            }
        }
        /* Style for the review cards */
        .review-correct {
            border-left: 5px solid #10b981;
        }
        .review-incorrect {
            border-left: 5px solid #ef4444;
        }
        .review-skipped {
            border-left: 5px solid #6b7280; /* Gray 500 */
        }
        .tts-button {
            transition: all 0.2s;
        }
        .tts-button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div id="app-container" class="container w-full bg-white shadow-xl rounded-2xl p-6 md:p-8">
        <h1 class="text-3xl font-bold text-gray-800 text-center mb-6">ðŸ‡ªðŸ‡¸ Spanish Language Trainer</h1>

        <div id="level-selection" class="text-center">
            
            <div class="mb-6 p-4 bg-gray-100 rounded-xl shadow-inner">
                <p class="text-md font-semibold text-gray-700 mb-3">1. Select Quiz Mode (10 Questions):</p>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-2">
                    <label class="flex items-center p-2 rounded-lg cursor-pointer transition duration-150 justify-center bg-red-200 shadow-sm"
                           onclick="setQuizMode('mc')">
                        <input type="radio" name="quiz_mode" value="mc" checked id="mode-mc" class="form-radio text-red-500 h-4 w-4">
                        <span class="ml-2 text-gray-800 font-bold text-xs md:text-sm">Spanish to English (MC)</span>
                    </label>
                    <label class="flex items-center p-2 rounded-lg cursor-pointer transition duration-150 justify-center bg-white shadow-sm"
                           onclick="setQuizMode('typing')">
                        <input type="radio" name="quiz_mode" value="typing" id="mode-typing" class="form-radio text-red-500 h-4 w-4">
                        <span class="ml-2 text-gray-700 font-medium text-xs md:text-sm">English to Spanish (Typing)</span>
                    </label>
                    <label class="flex items-center p-2 rounded-lg cursor-pointer transition duration-150 justify-center bg-white shadow-sm"
                           onclick="setQuizMode('speaking')">
                        <input type="radio" name="quiz_mode" value="speaking" id="mode-speaking" class="form-radio text-red-500 h-4 w-4">
                        <span class="ml-2 text-gray-700 font-medium text-xs md:text-sm">Spanish Speaking (Spanish Q)</span>
                    </label>
                    <label class="flex items-center p-2 rounded-lg cursor-pointer transition duration-150 justify-center bg-white shadow-sm"
                           onclick="setQuizMode('reverse-speaking')">
                        <input type="radio" name="quiz_mode" value="reverse-speaking" id="mode-reverse-speaking" class="form-radio text-red-500 h-4 w-4">
                        <span class="ml-2 text-gray-700 font-medium text-xs md:text-sm">English to Spanish (English Q)</span>
                    </label>
                    <label class="flex items-center p-2 rounded-lg cursor-pointer transition duration-150 justify-center bg-white shadow-sm"
                           onclick="setQuizMode('pronunciation')">
                        <input type="radio" name="quiz_mode" value="pronunciation" id="mode-pronunciation" class="form-radio text-red-500 h-4 w-4">
                        <span class="ml-2 text-gray-700 font-medium text-xs md:text-sm">Pronunciation & Listening</span>
                    </label>
                </div>
            </div>

            <p class="text-md font-semibold text-gray-700 mb-3">2. Select Level:</p>
            <div id="level-buttons" class="grid grid-cols-2 gap-4">
                </div>
        </div>

        <div id="quiz-screen" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <span id="current-level-display" class="px-3 py-1 bg-red-500 text-white text-sm font-semibold rounded-full">Level: Novice</span>
                <span id="question-counter" class="text-lg font-medium text-gray-700">Question 1/10</span>
            </div>

            <div id="quiz-content" class="p-8 bg-red-100 border-l-4 border-red-500 rounded-xl mb-8 shadow-md min-h-[100px] flex flex-col justify-center items-center">
                </div>

            <div id="answer-area" class="grid grid-cols-1 gap-4">
                </div>
        </div>

        <div id="results-screen" class="hidden text-center p-6 bg-green-50 rounded-xl shadow-inner">
            <h2 class="text-3xl font-bold text-green-700 mb-4">Quiz Complete! ðŸŽ‰</h2>
            <p class="text-xl text-gray-700 mb-6">You scored <span id="final-score" class="font-extrabold text-red-600">0</span> out of 10.</p>
            <p id="score-message" class="text-lg font-semibold text-gray-600 mb-8"></p>
            
            <div class="flex flex-col space-y-3">
                <button onclick="copyReviewToClipboard(this)" id="copy-button" class="w-full py-3 bg-blue-500 text-white font-bold rounded-xl shadow-lg hover:bg-blue-600 transition duration-150">
                    <i class="fas fa-clipboard"></i> Copy Review to Clipboard
                </button>
                <button onclick="resetQuiz()" class="w-full py-3 bg-red-500 text-white font-bold rounded-xl shadow-lg hover:bg-red-600 transition duration-150">
                    <i class="fas fa-redo"></i> Start New Quiz
                </button>
            </div>

            <div id="review-list" class="mt-6 pt-4 border-t border-gray-200 text-left">
                <h3 class="text-2xl font-bold text-gray-800 mb-4 text-center">Quiz Review</h3>
                </div>
        </div>
    </div>

    <script>
        // --- Data Structure (Expanded to 30+ entries per level) ---

        // Data for MC (Spanish -> English) and Typing (English -> Spanish) modes
        const wordData = {
            novice: [
                // 30 entries for Novice (A1-A2)
                { word: 'Hola', correct: 'Hello', distractors: ['Goodbye', 'Thank you', 'Yes'] },
                { word: 'Agua', correct: 'Water', distractors: ['Fire', 'Food', 'Air'] },
                { word: 'Comer', correct: 'To eat', distractors: ['To run', 'To sleep', 'To talk'] },
                { word: 'Grande', correct: 'Big', distractors: ['Small', 'Fast', 'Hot'] },
                { word: 'Casa', correct: 'House', distractors: ['Car', 'Book', 'Tree'] },
                { word: 'Rojo', correct: 'Red', distractors: ['Blue', 'Green', 'Yellow'] },
                { word: 'DÃ­a', correct: 'Day', distractors: ['Night', 'Month', 'Year'] },
                { word: 'Yo', correct: 'I', distractors: ['You', 'He', 'We'] },
                { word: 'Perro', correct: 'Dog', distractors: ['Cat', 'Bird', 'Fish'] },
                { word: 'Cincuenta', correct: 'Fifty', distractors: ['Ten', 'Twenty', 'One Hundred'] },
                { word: 'Gato', correct: 'Cat', distractors: ['Dog', 'Bird', 'Horse'] },
                { word: 'MaÃ±ana', correct: 'Tomorrow', distractors: ['Yesterday', 'Today', 'Later'] },
                { word: 'Noche', correct: 'Night', distractors: ['Morning', 'Afternoon', 'Evening'] },
                { word: 'Libro', correct: 'Book', distractors: ['Pen', 'Paper', 'Desk'] },
                { word: 'Gracias', correct: 'Thank you', distractors: ['Hello', 'Excuse me', 'Please'] },
                { word: 'Por favor', correct: 'Please', distractors: ['Stop', 'Hurry', 'Wait'] },
                { word: 'AdiÃ³s', correct: 'Goodbye', distractors: ['Hello', 'See you later', 'Nice to meet you'] },
                { word: 'TÃº', correct: 'You (singular informal)', distractors: ['I', 'He', 'We'] },
                { word: 'Nosotros', correct: 'We', distractors: ['I', 'You', 'They'] },
                { word: 'Ellos', correct: 'They (masculine/mixed)', distractors: ['She', 'It', 'We'] },
                { word: 'Hermano', correct: 'Brother', distractors: ['Sister', 'Cousin', 'Friend'] },
                { word: 'Padre', correct: 'Father', distractors: ['Mother', 'Son', 'Daughter'] },
                { word: 'Madre', correct: 'Mother', distractors: ['Father', 'Uncle', 'Aunt'] },
                { word: 'Coche', correct: 'Car', distractors: ['Train', 'Bike', 'Bus'] },
                { word: 'Sol', correct: 'Sun', distractors: ['Moon', 'Star', 'Cloud'] },
                { word: 'Luz', correct: 'Light', distractors: ['Darkness', 'Shadow', 'Noise'] },
                { word: 'Abrir', correct: 'To open', distractors: ['To close', 'To put', 'To take'] },
                { word: 'Cerrar', correct: 'To close', distractors: ['To open', 'To walk', 'To talk'] },
                { word: 'SÃ­', correct: 'Yes', distractors: ['No', 'Maybe', 'Always'] },
                { word: 'No', correct: 'No', distractors: ['Yes', 'Perhaps', 'Later'] },
            ],
            intermediate: [
                // 30 entries for Intermediate (B1-B2)
                { word: 'A menudo', correct: 'Often', distractors: ['Seldom', 'Always', 'Suddenly'] },
                { word: 'Sin embargo', correct: 'However', distractors: ['Therefore', 'Moreover', 'Besides'] },
                { word: 'Desarrollar', correct: 'To develop', distractors: ['To destroy', 'To define', 'To design'] },
                { word: 'El reto', correct: 'The challenge', distractors: ['The reward', 'The result', 'The reason'] },
                { word: 'A pesar de', correct: 'Despite', distractors: ['Because of', 'In order to', 'Except for'] },
                { word: 'Conocimiento', correct: 'Knowledge', distractors: ['Friendship', 'Recognition', 'Consciousness'] },
                { word: 'Lograr', correct: 'To achieve', distractors: ['To lose', 'To fail', 'To hide'] },
                { word: 'Exigir', correct: 'To demand', distractors: ['To ask', 'To beg', 'To suggest'] },
                { word: 'Medio ambiente', correct: 'Environment', distractors: ['Government', 'Economy', 'Education'] },
                { word: 'Confianza', correct: 'Trust/Confidence', distractors: ['Doubt', 'Fear', 'Anger'] },
                { word: 'Superar', correct: 'To overcome', distractors: ['To supervise', 'To support', 'To surrender'] },
                { word: 'El compromiso', correct: 'The commitment', distractors: ['The mistake', 'The conflict', 'The distraction'] },
                { word: 'Destacar', correct: 'To stand out/Highlight', distractors: ['To hide', 'To follow', 'To whisper'] },
                { word: 'El ciudadano', correct: 'The citizen', distractors: ['The soldier', 'The tourist', 'The alien'] },
                { word: 'La inversiÃ³n', correct: 'The investment', distractors: ['The expense', 'The loan', 'The budget'] },
                { word: 'El esfuerzo', correct: 'The effort', distractors: ['The rest', 'The ease', 'The luck'] },
                { word: 'Proponer', correct: 'To propose', distractors: ['To oppose', 'To forget', 'To confirm'] },
                { word: 'Sostenible', correct: 'Sustainable', distractors: ['Temporary', 'Expensive', 'Difficult'] },
                { word: 'La habilidad', correct: 'The ability/skill', distractors: ['The fault', 'The weakness', 'The feeling'] },
                { word: 'Apreciar', correct: 'To appreciate', distractors: ['To criticize', 'To ignore', 'To sell'] },
                { word: 'La herramienta', correct: 'The tool', distractors: ['The door', 'The clock', 'The carpet'] },
                { word: 'El vÃ­nculo', correct: 'The link/bond', distractors: ['The separation', 'The wall', 'The sound'] },
                { word: 'Disminuir', correct: 'To diminish/decrease', distractors: ['To increase', 'To maintain', 'To multiply'] },
                { word: 'Enfocarse', correct: 'To focus', distractors: ['To wander', 'To sleep', 'To laugh'] },
                { word: 'La desigualdad', correct: 'The inequality', distractors: ['The equality', 'The justice', 'The honesty'] },
                { word: 'El crecimiento', correct: 'The growth', distractors: ['The reduction', 'The halt', 'The balance'] },
                { word: 'La incertidumbre', correct: 'The uncertainty', distractors: ['The certainty', 'The belief', 'The peace'] },
                { word: 'El bienestar', correct: 'The well-being', distractors: ['The illness', 'The poverty', 'The noise'] },
                { word: 'Rechazar', correct: 'To reject', distractors: ['To accept', 'To invite', 'To create'] },
                { word: 'La propuesta', correct: 'The proposal', distractors: ['The silence', 'The denial', 'The tradition'] },
            ],
            advanced: [
                // 30 entries for Advanced (C1)
                { word: 'Asegurar', correct: 'To ensure', distractors: ['To calculate', 'To insure', 'To argue'] },
                { word: 'El matiz', correct: 'The nuance', distractors: ['The rhythm', 'The darkness', 'The texture'] },
                { word: 'Por ende', correct: 'Therefore', distractors: ['Otherwise', 'Meanwhile', 'Similarly'] },
                { word: 'El umbral', correct: 'The threshold', distractors: ['The ceiling', 'The window', 'The foundation'] },
                { word: 'OjalÃ¡', correct: 'I hope so (God willing)', distractors: ['Maybe later', 'It is true', 'Finally'] },
                { word: 'Superar', correct: 'To overcome', distractors: ['To supervise', 'To support', 'To surpass'] },
                { word: 'La polÃ©mica', correct: 'Controversy', distractors: ['Agreement', 'Consensus', 'Harmony'] },
                { word: 'El sesgo', correct: 'Bias', distractors: ['Truth', 'Fairness', 'Objective'] },
                { word: 'La Ã­ndole', correct: 'Nature/Character (of a thing)', distractors: ['Size', 'Color', 'Taste'] },
                { word: 'Postular', correct: 'To postulate/apply', distractors: ['To refuse', 'To deny', 'To withdraw'] },
                { word: 'El desfalco', correct: 'The embezzlement', distractors: ['The payment', 'The donation', 'The savings'] },
                { word: 'La lacra', correct: 'The scourge/blemish', distractors: ['The blessing', 'The jewel', 'The success'] },
                { word: 'Acatar', correct: 'To comply/obey', distractors: ['To rebel', 'To hide', 'To negotiate'] },
                { word: 'La coyuntura', correct: 'The situation/conjuncture', distractors: ['The history', 'The future', 'The solution'] },
                { word: 'Transigir', correct: 'To compromise/give in', distractors: ['To insist', 'To win', 'To start'] },
                { word: 'La reticencia', correct: 'The reluctance', distractors: ['The eagerness', 'The belief', 'The laughter'] },
                { word: 'Fomentar', correct: 'To foster/promote', distractors: ['To discourage', 'To destroy', 'To abandon'] },
                { word: 'El paradigma', correct: 'The paradigm', distractors: ['The error', 'The fragment', 'The deviation'] },
                { word: 'Elocuente', correct: 'Eloquent', distractors: ['Silent', 'Awkward', 'Hesitant'] },
                { word: 'Subyacente', correct: 'Underlying', distractors: ['Visible', 'Obvious', 'Trivial'] },
                { word: 'La hegemonÃ­a', correct: 'The hegemony', distractors: ['The equality', 'The chaos', 'The weakness'] },
                { word: 'Irrefutable', correct: 'Irrefutable', distractors: ['Questionable', 'False', 'Hypothetical'] },
                { word: 'El preÃ¡mbulo', correct: 'The preamble', distractors: ['The conclusion', 'The chapter', 'The result'] },
                { word: 'Apremiante', correct: 'Urgent/Pressing', distractors: ['Minor', 'Slow', 'Relaxing'] },
                { word: 'La diatriba', correct: 'The diatribe/rant', distractors: ['The compliment', 'The song', 'The silence'] },
                { word: 'Susceptible', correct: 'Susceptible/Liable', distractors: ['Resistant', 'Strong', 'Hardy'] },
                { word: 'Ponderar', correct: 'To weigh/consider', distractors: ['To decide', 'To forget', 'To ignore'] },
                { word: 'La tesitura', correct: 'The situation/position', distractors: ['The time', 'The color', 'The texture'] },
                { word: 'Prevalecer', correct: 'To prevail', distractors: ['To fail', 'To surrender', 'To stop'] },
                { word: 'La discrepancia', correct: 'The discrepancy', distractors: ['The agreement', 'The harmony', 'The similarity'] },
            ],
            fluent: [
                // 30 entries for Fluent (C2 - Idioms/Phrases)
                { word: 'Estar de chÃ¡chara', correct: 'To be chatting (casually)', distractors: ['To be angry', 'To be silent', 'To be working'] },
                { word: 'A troche y moche', correct: 'Willy-nilly/Haphazardly', distractors: ['Carefully', 'Immediately', 'In silence'] },
                { word: 'Estar al loro', correct: 'To be alert/aware', distractors: ['To be hungry', 'To be bored', 'To be confused'] },
                { word: 'Ser pan comido', correct: 'To be a piece of cake (easy)', distractors: ['To be impossible', 'To be fun', 'To be boring'] },
                { word: 'Irse por las ramas', correct: 'To beat around the bush', distractors: ['To go outside', 'To be direct', 'To climb a tree'] },
                { word: 'El meollo', correct: 'The core/crux', distractors: ['The shell', 'The obstacle', 'The distraction'] },
                { word: 'Armarse un follÃ³n', correct: 'To cause a commotion', distractors: ['To apologize', 'To clean up', 'To relax'] },
                { word: 'A duras penas', correct: 'With great difficulty', distractors: ['Easily', 'Quickly', 'Lazily'] },
                { word: 'Hacer caso', correct: 'To pay attention/take notice', distractors: ['To ignore', 'To forget', 'To hurry'] },
                { word: 'Estar en ascuas', correct: 'To be on pins and needles', distractors: ['To be relaxing', 'To be asleep', 'To be certain'] },
                { word: 'Echar un cable', correct: 'To lend a hand/help out', distractors: ['To cut a rope', 'To plug in', 'To start a car'] },
                { word: 'Ponerse las pilas', correct: 'To get moving/buckle down', distractors: ['To be lazy', 'To sleep late', 'To put on shoes'] },
                { word: 'Estar como una cabra', correct: 'To be crazy/nutty', distractors: ['To be cold', 'To be hungry', 'To be nervous'] },
                { word: 'Tirar la toalla', correct: 'To throw in the towel/give up', distractors: ['To clean up', 'To start over', 'To get ready'] },
                { word: 'Buscarle tres pies al gato', correct: 'To complicate things unnecessarily', distractors: ['To find a pet', 'To solve a problem', 'To search for a cat'] },
                { word: 'De golpe y porrazo', correct: 'All of a sudden', distractors: ['Very slowly', 'With planning', 'One by one'] },
                { word: 'Estar hecho un lÃ­o', correct: 'To be confused/a mess', distractors: ['To be tidy', 'To be happy', 'To be focused'] },
                { word: 'No tener pelos en la lengua', correct: 'To be straightforward/say what you think', distractors: ['To be polite', 'To be shy', 'To be quiet'] },
                { word: 'Dar en el clavo', correct: 'To hit the nail on the head/be right', distractors: ['To make a mistake', 'To be wrong', 'To miss the target'] },
                { word: 'Ser uÃ±a y carne', correct: 'To be inseparable/very close', distractors: ['To be enemies', 'To be distant', 'To be confused'] },
                { word: 'A capa y espada', correct: 'Tooth and nail/fiercely', distractors: ['With care', 'With silence', 'With doubt'] },
                { word: 'Estar como pez en el agua', correct: 'To be completely comfortable/in one\'s element', distractors: ['To be lost', 'To be sick', 'To be bored'] },
                { word: 'No es moco de pavo', correct: 'It\'s no small matter', distractors: ['It is easy', 'It is funny', 'It is trivial'] },
                { word: 'Meter la pata', correct: 'To put one\'s foot in one\'s mouth/mess up', distractors: ['To fix a problem', 'To speak clearly', 'To stand up'] },
                { word: 'Echar leÃ±a al fuego', correct: 'To add fuel to the fire', distractors: ['To calm things down', 'To put out a fire', 'To turn off the light'] },
                { word: 'Ser la oveja negra', correct: 'To be the black sheep', distractors: ['To be the favorite', 'To be the leader', 'To be silent'] },
                { word: 'Tener mala leche', correct: 'To be bad-tempered', distractors: ['To be hungry', 'To be happy', 'To be tired'] },
                { word: 'Estar en Babia', correct: 'To be daydreaming/out of it', distractors: ['To be focused', 'To be listening', 'To be running'] },
                { word: 'Hacer borrÃ³n y cuenta nueva', correct: 'To wipe the slate clean/start over', distractors: ['To remember everything', 'To keep a secret', 'To finish a project'] },
                { word: 'MÃ¡s vale tarde que nunca', correct: 'Better late than never', distractors: ['Hurry up', 'Never mind', 'That\'s fine'] },
            ]
        };

        // Data for Speaking modes (Expanded)
        const speakingData = {
            forward: { // Spanish Q, User Answers in Spanish
                novice: [
                    { question: 'Â¿CÃ³mo te llamas?', spanish: 'Me llamo...', english: 'My name is...', keywords: 'Me llamo' },
                    { question: 'Â¿CuÃ¡ntos aÃ±os tienes?', spanish: 'Tengo... aÃ±os.', english: 'I am... years old.', keywords: 'Tengo aÃ±os' },
                    { question: 'Â¿De dÃ³nde eres?', spanish: 'Soy de...', english: 'I am from...', keywords: 'Soy de' },
                    { question: 'Â¿CÃ³mo estÃ¡s hoy?', spanish: 'Estoy bien/mal/cansado(a).', english: 'I am well/bad/tired.', keywords: 'Estoy' },
                    { question: 'Â¿QuÃ© hora es?', spanish: 'Son las... / Es la una.', english: 'It is...', keywords: 'Son las Es la' },
                    { question: 'Â¿QuÃ© tiempo hace?', spanish: 'Hace sol/frÃ­o/calor.', english: 'It is sunny/cold/hot.', keywords: 'Hace sol frÃ­o calor' },
                    { question: 'Â¿Te gusta leer?', spanish: 'SÃ­, me gusta leer / No, no me gusta.', english: 'Yes, I like to read / No, I don\'t like it.', keywords: 'gusta leer' },
                    { question: 'Â¿Tienes un perro o un gato?', spanish: 'Tengo un perro/gato / No tengo.', english: 'I have a dog/cat / I don\'t have one.', keywords: 'Tengo perro gato' },
                    { question: 'Â¿QuÃ© comes para el desayuno?', spanish: 'Como pan y cafÃ©.', english: 'I eat bread and coffee.', keywords: 'Como pan cafÃ©' },
                    { question: 'Â¿DÃ³nde vives?', spanish: 'Vivo en una casa/apartamento.', english: 'I live in a house/apartment.', keywords: 'Vivo casa apartamento' },
                ],
                intermediate: [
                    { question: 'Â¿QuÃ© opinas sobre el medio ambiente?', spanish: 'Creo que es crucial proteger el medio ambiente.', english: 'I believe it is crucial to protect the environment.', keywords: 'crucial proteger medio ambiente' },
                    { question: 'Â¿CuÃ¡l es el mayor reto hoy?', spanish: 'El mayor reto es la desigualdad econÃ³mica.', english: 'The biggest challenge is economic inequality.', keywords: 'mayor reto desigualdad econÃ³mica' },
                    { question: 'Â¿QuÃ© planes tienes para el futuro?', spanish: 'Planeo desarrollar nuevas habilidades y viajar.', english: 'I plan to develop new skills and travel.', keywords: 'desarrollar habilidades viajar' },
                    { question: 'Â¿Por quÃ© es importante el conocimiento?', spanish: 'El conocimiento nos da confianza y nos ayuda a superar.', english: 'Knowledge gives us confidence and helps us overcome.', keywords: 'conocimiento confianza superar' },
                    { question: 'Â¿QuÃ© harÃ­as para fomentar la educaciÃ³n?', spanish: 'PropondrÃ­a una inversiÃ³n sostenible en recursos educativos.', english: 'I would propose a sustainable investment in educational resources.', keywords: 'inversiÃ³n sostenible recursos educativos' },
                    { question: 'Â¿QuÃ© valoras en la amistad?', spanish: 'Valoro la confianza, el apoyo y el compromiso.', english: 'I value trust, support, and commitment.', keywords: 'Valoro confianza apoyo compromiso' },
                    { question: 'Â¿CÃ³mo se puede lograr la paz?', spanish: 'Debemos enfocarnos en la comunicaciÃ³n y disminuir la violencia.', english: 'We must focus on communication and diminish violence.', keywords: 'enfocarnos comunicaciÃ³n disminuir violencia' },
                    { question: 'Â¿Con quÃ© frecuencia lees libros?', spanish: 'Leo a menudo, por lo menos una vez a la semana.', english: 'I read often, at least once a week.', keywords: 'Leo a menudo una vez semana' },
                    { question: 'Â¿QuÃ© te exige tu trabajo?', spanish: 'Mi trabajo me exige esfuerzo, habilidad y concentraciÃ³n.', english: 'My job demands effort, skill, and concentration from me.', keywords: 'exige esfuerzo habilidad concentraciÃ³n' },
                    { question: 'Â¿CÃ³mo reaccionarÃ­as ante la incertidumbre?', spanish: 'MantendrÃ­a la calma a pesar de la incertidumbre.', english: 'I would remain calm despite the uncertainty.', keywords: 'MantendrÃ­a calma a pesar incertidumbre' },
                ],
                advanced: [/* ... similar complexity ... */],
                fluent: [/* ... similar complexity ... */],
            },
            reverse: { // English Q, User Answers in Spanish
                novice: [
                    { question: 'Ask me for a glass of water.', spanish: 'Quiero un vaso de agua, por favor.', english: 'I want a glass of water, please.', keywords: 'vaso agua favor' },
                    { question: 'Say: "I live in a big house."', spanish: 'Vivo en una casa grande.', english: 'I live in a big house.', keywords: 'Vivo casa grande' },
                    { question: 'Say: "The red book is on the table."', spanish: 'El libro rojo estÃ¡ en la mesa.', english: 'The red book is on the table.', keywords: 'libro rojo mesa' },
                    { question: 'Ask: "Where is the nearest bathroom?"', spanish: 'Â¿DÃ³nde estÃ¡ el baÃ±o mÃ¡s cercano?', english: 'Where is the nearest bathroom?', keywords: 'DÃ³nde baÃ±o cercano' },
                    { question: 'Say: "I need help with this."', spanish: 'Necesito ayuda con esto.', english: 'I need help with this.', keywords: 'Necesito ayuda esto' },
                    { question: 'Say: "I want to eat now."', spanish: 'Quiero comer ahora.', english: 'I want to eat now.', keywords: 'Quiero comer ahora' },
                    { question: 'Say: "Thank you and goodbye."', spanish: 'Gracias y adiÃ³s.', english: 'Thank you and goodbye.', keywords: 'Gracias adiÃ³s' },
                    { question: 'Say: "I am a student."', spanish: 'Soy estudiante.', english: 'I am a student.', keywords: 'Soy estudiante' },
                    { question: 'Say: "I have fifty dollars."', spanish: 'Tengo cincuenta dÃ³lares.', english: 'I have fifty dollars.', keywords: 'Tengo cincuenta dÃ³lares' },
                    { question: 'Say: "Today is a beautiful day."', spanish: 'Hoy es un dÃ­a hermoso.', english: 'Today is a beautiful day.', keywords: 'Hoy dÃ­a hermoso' },
                ],
                intermediate: [
                    { question: 'Say: "We need to overcome the challenge."', spanish: 'Necesitamos superar el reto.', english: 'We need to overcome the challenge.', keywords: 'Necesitamos superar reto' },
                    { question: 'Say: "Despite the conflict, they achieved success."', spanish: 'A pesar del conflicto, lograron el Ã©xito.', english: 'Despite the conflict, they achieved success.', keywords: 'pesar conflicto lograron Ã©xito' },
                    { question: 'Say: "The commitment to development is important."', spanish: 'El compromiso con el desarrollo es importante.', english: 'The commitment to development is important.', keywords: 'compromiso desarrollo importante' },
                    { question: 'Say: "We must appreciate the effort."', spanish: 'Debemos apreciar el esfuerzo.', english: 'We must appreciate the effort.', keywords: 'Debemos apreciar esfuerzo' },
                    { question: 'Say: "He proposes a sustainable solution."', spanish: 'Ã‰l propone una soluciÃ³n sostenible.', english: 'He proposes a sustainable solution.', keywords: 'propone soluciÃ³n sostenible' },
                    { question: 'Say: "The tool is essential for the growth."', spanish: 'La herramienta es esencial para el crecimiento.', english: 'The tool is essential for the growth.', keywords: 'herramienta esencial crecimiento' },
                    { question: 'Say: "They demand absolute confidence."', spanish: 'Ellos exigen confianza absoluta.', english: 'They demand absolute confidence.', keywords: 'exigen confianza absoluta' },
                    { question: 'Say: "She tends to stand out often."', spanish: 'Ella suele destacar a menudo.', english: 'She tends to stand out often.', keywords: 'suele destacar menudo' },
                    { question: 'Say: "The well-being of the citizen is vital."', spanish: 'El bienestar del ciudadano es vital.', english: 'The well-being of the citizen is vital.', keywords: 'bienestar ciudadano vital' },
                    { question: 'Say: "However, we should decrease the inequality."', spanish: 'Sin embargo, deberÃ­amos disminuir la desigualdad.', english: 'However, we should decrease the inequality.', keywords: 'Sin embargo disminuir desigualdad' },
                ],
                advanced: [/* ... similar complexity ... */],
                fluent: [/* ... similar complexity ... */],
            }
        };

        // Data for NEW Pronunciation Mode (Expanded to 30 sentences per level)
        const pronunciationData = {
            novice: [
                'Yo quiero un vaso de agua, por favor.',
                'Â¿DÃ³nde estÃ¡ el baÃ±o mÃ¡s cercano?',
                'Hoy hace sol y la temperatura es buena.',
                'Mi familia y yo vivimos en una casa pequeÃ±a.',
                'Tengo dos hermanos y una hermana mayor.',
                'La capital de EspaÃ±a es la ciudad de Madrid.',
                'Me gusta mucho leer libros de historia.',
                'Â¿A quÃ© hora empieza la pelÃ­cula?',
                'El perro duerme debajo de la mesa.',
                'Voy al supermercado a comprar comida fresca.',
                'Necesito ayuda con este ejercicio difÃ­cil.',
                'Â¿QuÃ© vas a hacer este fin de semana?',
                'Ella habla inglÃ©s y tambiÃ©n un poco de francÃ©s.',
                'Son las tres y media de la tarde.',
                'Prefiero el tÃ© caliente sin azÃºcar.',
                'Mi color favorito es el azul oscuro.',
                'Trabajo en una oficina cerca del centro.',
                'El coche nuevo es muy rÃ¡pido.',
                'Â¿CuÃ¡nto cuesta un billete a Sevilla?',
                'Estoy cansado despuÃ©s de un largo dÃ­a de trabajo.',
                'Quiero aprender a cocinar platos espaÃ±oles.',
                'El niÃ±o juega con una pelota roja.',
                'Puedes encontrar la llave en la cocina.',
                'No entiendo esta palabra, Â¿quÃ© significa?',
                'Hablamos por telÃ©fono todos los dÃ­as.',
                'Siempre me levanto a las siete de la maÃ±ana.',
                'Me duele la cabeza, necesito un cafÃ©.',
                'Cierra la puerta cuando salgas de la habitaciÃ³n.',
                'Â¿QuiÃ©n es esa persona con el abrigo gris?',
                'Voy a visitar a mis abuelos maÃ±ana.'
            ],
            intermediate: [
                'A pesar de la lluvia, decidimos salir a pasear.',
                'La inversiÃ³n en tecnologÃ­a ha aumentado mucho.',
                'Es fundamental desarrollar habilidades comunicativas.',
                'El medio ambiente necesita nuestra protecciÃ³n urgente.',
                'Sin embargo, la situaciÃ³n sigue siendo incierta.',
                'El esfuerzo constante nos ayuda a superar retos.',
                'Me gustarÃ­a viajar a paÃ­ses exÃ³ticos el prÃ³ximo aÃ±o.',
                'La desigualdad econÃ³mica es un problema global.',
                'Es importante fomentar la confianza en el equipo.',
                'Describe cÃ³mo el conocimiento cambia tu perspectiva.',
                'Analicemos la propuesta antes de tomar una decisiÃ³n.',
                'Ella logrÃ³ su objetivo gracias a su perseverancia.',
                'El crecimiento sostenible beneficia a todos.',
                'Â¿QuÃ© cualidad valoras mÃ¡s en un lÃ­der polÃ­tico?',
                'La habilidad para adaptarse es crucial hoy en dÃ­a.',
                'Â¿CuÃ¡l es el mayor desafÃ­o que enfrenta la humanidad?',
                'El vÃ­nculo entre cultura y lengua es muy fuerte.',
                'Debemos disminuir el consumo de plÃ¡stico.',
                'Me enfocarÃ© en terminar este proyecto hoy mismo.',
                'El bienestar emocional es tan vital como el fÃ­sico.',
                'El compromiso social exige acciÃ³n, no solo palabras.',
                'La herramienta mÃ¡s Ãºtil es la educaciÃ³n.',
                'Â¿QuÃ© opinas sobre el impacto de la inteligencia artificial?',
                'La propuesta fue rechazada por falta de fondos.',
                'Necesitamos destacar la importancia de la historia.',
                'Â¿QuÃ© harÃ­as si pudieras cambiar el pasado?',
                'La incertidumbre econÃ³mica nos afecta a todos.',
                'Es apremiante encontrar una soluciÃ³n rÃ¡pida.',
                'El futuro de las ciudades serÃ¡ mÃ¡s ecolÃ³gico.',
                'El jefe nos exigiÃ³ mÃ¡xima calidad en el trabajo.'
            ],
            advanced: [
                'PostulÃ³ una teorÃ­a que rompe con el paradigma vigente.',
                'El sesgo mediÃ¡tico influye profundamente en la opiniÃ³n pÃºblica.',
                'Debemos acatar las normas por el bien de la comunidad.',
                'La coyuntura polÃ­tica actual es extremadamente volÃ¡til.',
                'Hay una reticencia generalizada a transigir en este asunto.',
                'La dicotomÃ­a entre la tradiciÃ³n y la modernidad persiste.',
                'Esa conclusiÃ³n parece irrefutable dadas las pruebas.',
                'El preÃ¡mbulo de la ley establece los principios fundamentales.',
                'La discrepancia de criterios complicÃ³ el acuerdo final.',
                'No es moco de pavo resolver el meollo de este dilema.',
                'El fenÃ³meno subyacente requiere un anÃ¡lisis mÃ¡s profundo.',
                'Por ende, es imperativo asegurar la sostenibilidad del sistema.',
                'OjalÃ¡ el nuevo gobierno fomente la inversiÃ³n a largo plazo.',
                'El matiz lingÃ¼Ã­stico en esta frase es sutil pero relevante.',
                'La hegemonÃ­a cultural se manifiesta de diversas maneras.',
                'Su elocuente discurso conmoviÃ³ a toda la audiencia.',
                'El desfalco millonario ha sido la lacra de la empresa.',
                'Conviene ponderar cuidadosamente los pros y los contras.',
                'La tesitura actual demanda medidas extraordinarias.',
                'La diatriba del opositor fue sumamente incendiaria.',
                'El tejido social se muestra susceptible a estos cambios.',
                'La ambigÃ¼edad semÃ¡ntica crea confusiÃ³n innecesaria.',
                'Las variables endÃ³genas distorsionan el modelo predictivo.',
                'Un juicio salomÃ³nico serÃ­a lo mÃ¡s apropiado ahora.',
                'Debe prevalecer la razÃ³n por encima de la emociÃ³n.',
                'La idiosincrasia de la regiÃ³n es muy particular.',
                'Es crucial desentraÃ±ar la complejidad del asunto.',
                'La prosopopeya es una figura retÃ³rica muy potente.'
            ],
            fluent: [
                'DespuÃ©s del conflicto, hicieron borrÃ³n y cuenta nueva.',
                'Ella es la oveja negra de la familia, siempre rebelde.',
                'No te vayas por las ramas, ve al grano del problema.',
                'El examen fue pan comido, lo terminÃ© en diez minutos.',
                'Hay que ponerse las pilas para acabar el proyecto a tiempo.',
                'Estaba tan nervioso que se sentÃ­a como pez fuera del agua.',
                'DefendiÃ³ su postura a capa y espada en la reuniÃ³n.',
                'Mi primo tiene muy mala leche cuando no ha comido.',
                'Cuando estÃ¡s en Babia no haces caso a lo que te dicen.',
                'Con el tiempo, logramos dar en el clavo con la soluciÃ³n.',
                'Los dos hermanos son uÃ±a y carne desde que eran niÃ±os.',
                'Tuvieron que echarle un cable para pagar la hipoteca.',
                'Se armÃ³ un follÃ³n tremendo en la calle por el accidente.',
                'A duras penas pudo terminar la maratÃ³n de la ciudad.',
                'De golpe y porrazo, el sistema colapsÃ³ por la sobrecarga.',
                'Para entender el meollo del asunto, hay que leer el informe.',
                'No es moco de pavo haber levantado esa empresa tÃº solo.',
                'EstÃ¡ hecho un lÃ­o con las instrucciones del nuevo aparato.',
                'El polÃ­tico no tiene pelos en la lengua al hablar de corrupciÃ³n.',
                'Echar leÃ±a al fuego solo empeorarÃ¡ la situaciÃ³n actual.',
                'MÃ¡s vale tarde que nunca llegar a un acuerdo en esto.',
                'Para estar al loro de las noticias, leo varios periÃ³dicos.',
                'La abuela pasa las tardes de chÃ¡chara con sus vecinas.',
                'EmpezÃ³ a gastar dinero a troche y moche sin control.',
                'Estamos en ascuas esperando el resultado del anÃ¡lisis.',
                'Intentar justificarlo es buscarle tres pies al gato.',
                'Conviene ir con pies de plomo en este tipo de negocios.',
                'Le tocÃ³ bailar con la mÃ¡s fea en la negociaciÃ³n.',
                'Se puso como un tomate cuando le dijeron un piropo.',
                'No hay que andarse con chiquitas, la verdad es simple.'
            ]
        };

        // --- State Management ---
        let currentLevel = null;
        let currentQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let isAnswerLocked = false;
        let quizHistory = [];
        let quizMode = 'mc'; // 'mc', 'typing', 'speaking', 'reverse-speaking', 'pronunciation'

        // Web Speech API Initialization
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'es-ES'; // Set language to Spanish
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;
        }

        // --- DOM Elements & Utilities ---
        const levelSelectionEl = document.getElementById('level-selection');
        const levelButtonsEl = document.getElementById('level-buttons');
        const quizScreenEl = document.getElementById('quiz-screen');
        const resultsScreenEl = document.getElementById('results-screen');
        const quizContentEl = document.getElementById('quiz-content');
        const answerAreaEl = document.getElementById('answer-area');
        const questionCounterEl = document.getElementById('question-counter');
        const currentLevelDisplayEl = document.getElementById('current-level-display');
        const finalScoreEl = document.getElementById('final-score');
        const scoreMessageEl = document.getElementById('score-message');
        const reviewListEl = document.getElementById('review-list');
        const copyButtonEl = document.getElementById('copy-button');

        let audioContext = null;

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function normalizeString(str) {
            return str.replace(/[.,/#!$%^&*;:{}=?"Â¿Â¡'()]/g,"").trim().toLowerCase();
        }

        // Calculates how similar the user's transcript is to the target sentence (simple word matching)
        function calculateSimilarity(target, transcript) {
            const normalizedTarget = normalizeString(target);
            const normalizedTranscript = normalizeString(transcript);

            if (!normalizedTranscript.length) return 0;

            const targetWords = normalizedTarget.split(/\s+/).filter(w => w.length > 0);
            const transcriptWords = normalizedTranscript.split(/\s+/).filter(w => w.length > 0);

            if (targetWords.length === 0) return 0;

            let matches = 0;
            const matchedIndices = new Set();
            
            // Simple search for matching words (ignoring word order and repetition)
            for (const tWord of transcriptWords) {
                // Find if the spoken word matches any remaining target word
                const targetIndex = targetWords.findIndex((tw, i) => !matchedIndices.has(i) && tw === tWord );
                if (targetIndex !== -1) {
                    matches++;
                    matchedIndices.add(targetIndex);
                }
            }

            // Grade based on percentage of target words correctly matched (allows for extra words)
            return (matches / targetWords.length) * 100;
        }

        function setQuizMode(mode) {
            quizMode = mode;
            const radioEl = document.getElementById(`mode-${mode}`);
            if (radioEl) {
                radioEl.checked = true;
            }

            // Update styling of mode buttons
            document.querySelectorAll('input[name="quiz_mode"]').forEach(input => {
                const label = input.closest('label');
                if (input.value === mode) {
                    label.classList.add('bg-red-200');
                    label.classList.remove('bg-white');
                    label.querySelector('span').classList.add('font-bold', 'text-gray-800');
                    label.querySelector('span').classList.remove('font-medium', 'text-gray-700');
                } else {
                    label.classList.remove('bg-red-200');
                    label.classList.add('bg-white');
                    label.querySelector('span').classList.remove('font-bold', 'text-gray-800');
                    label.querySelector('span').classList.add('font-medium', 'text-gray-700');
                }
            });

            // Adjust level buttons if a level is already selected, to re-initialize for the new mode
            if (currentLevel) {
                // This doesn't start the quiz, just resets the view if level was already chosen
                currentLevel = null;
                initializeLevelButtons(); 
            }
        }


        // --- UI Rendering ---

        function initializeLevelButtons() {
            levelButtonsEl.innerHTML = '';
            const levels = ['novice', 'intermediate', 'advanced', 'fluent'];
            levels.forEach(level => {
                const button = document.createElement('button');
                button.className = 'level-button bg-white text-red-600 border border-red-500 py-3 rounded-xl font-bold shadow-md hover:bg-red-500 hover:text-white transition duration-200';
                button.textContent = level.charAt(0).toUpperCase() + level.slice(1);
                button.onclick = () => startQuiz(level);
                levelButtonsEl.appendChild(button);
            });
        }

        function renderQuizContent() {
            const question = currentQuestions[currentQuestionIndex];
            const isSpeakingMode = ['speaking', 'reverse-speaking'].includes(quizMode);
            const isPronunciationMode = quizMode === 'pronunciation';
            const isTypingMode = quizMode === 'typing';

            quizContentEl.innerHTML = '';
            answerAreaEl.innerHTML = '';

            // 1. Render Question/Prompt Area
            let promptText = '';
            if (isSpeakingMode) {
                promptText = question.question; // Spanish or English question
            } else if (isPronunciationMode) {
                promptText = question; // Spanish sentence
            } else if (isTypingMode) {
                promptText = question.correct; // English translation for typing
            } else { // MC mode
                promptText = question.word; // Spanish word/phrase
            }

            // Add audio button for Spanish text
            if (isPronunciationMode || quizMode === 'mc') {
                const ttsText = isPronunciationMode ? promptText : question.word;
                const audioButton = document.createElement('button');
                audioButton.id = 'tts-button';
                audioButton.className = 'tts-button flex items-center justify-center p-3 text-white bg-red-500 rounded-full shadow-lg hover:bg-red-600 disabled:opacity-70 disabled:cursor-not-allowed';
                audioButton.innerHTML = '<i class="fas fa-volume-up text-xl"></i>';
                audioButton.onclick = () => generateAudio(ttsText);
                
                const promptContainer = document.createElement('div');
                promptContainer.className = 'flex flex-col items-center space-y-4';

                const textSpan = document.createElement('span');
                textSpan.className = 'text-3xl font-extrabold text-gray-800 text-center';
                textSpan.textContent = promptText;

                promptContainer.appendChild(textSpan);
                promptContainer.appendChild(audioButton);

                quizContentEl.appendChild(promptContainer);
            } else {
                quizContentEl.innerHTML = `<span class="text-3xl font-extrabold text-gray-800 text-center">${promptText}</span>`;
            }

            // 2. Render Answer Area
            if (isSpeakingMode || isPronunciationMode) {
                renderSpeechInput();
            } else if (isTypingMode) {
                renderTypingInput();
            } else { // MC Mode
                renderMultipleChoice(question);
            }

            // 3. Update Question Counter
            questionCounterEl.textContent = `Question ${currentQuestionIndex + 1}/10`;
            currentLevelDisplayEl.textContent = `Level: ${currentLevel.charAt(0).toUpperCase() + currentLevel.slice(1)}`;
        }

        function renderMultipleChoice(question) {
            const options = shuffleArray([question.correct, ...question.distractors]);
            
            options.forEach(option => {
                const button = document.createElement('button');
                button.className = 'answer-button bg-white text-gray-800 border border-gray-300 py-3 rounded-xl font-semibold shadow-sm hover:bg-gray-100 transition duration-150';
                button.textContent = option;
                button.onclick = () => checkAnswer(option);
                answerAreaEl.appendChild(button);
            });

            // Skip button for MC
            const skipButton = document.createElement('button');
            skipButton.className = 'mt-2 text-gray-500 font-medium hover:text-red-500 transition duration-150';
            skipButton.textContent = 'Skip Question';
            skipButton.onclick = () => skipQuestion();
            answerAreaEl.appendChild(skipButton);
        }

        function renderTypingInput() {
            const inputGroup = document.createElement('div');
            inputGroup.className = 'flex flex-col space-y-4';

            const input = document.createElement('input');
            input.id = 'typing-input';
            input.type = 'text';
            input.className = 'w-full px-4 py-3 border border-gray-300 rounded-xl text-lg focus:ring-red-500 focus:border-red-500';
            input.placeholder = 'Type your Spanish answer here...';
            input.onkeypress = (e) => {
                if (e.key === 'Enter' && !isAnswerLocked) {
                    checkTypingAnswer(input.value);
                }
            };
            inputGroup.appendChild(input);

            const submitButton = document.createElement('button');
            submitButton.className = 'py-3 bg-red-500 text-white font-bold rounded-xl shadow-lg hover:bg-red-600 transition duration-150';
            submitButton.textContent = 'Submit Answer';
            submitButton.onclick = () => checkTypingAnswer(document.getElementById('typing-input').value);
            inputGroup.appendChild(submitButton);

            const skipButton = document.createElement('button');
            skipButton.className = 'mt-2 text-gray-500 font-medium hover:text-red-500 transition duration-150';
            skipButton.textContent = 'Skip Question';
            skipButton.onclick = () => skipQuestion();
            inputGroup.appendChild(skipButton);

            answerAreaEl.appendChild(inputGroup);
            input.focus();
        }

        function renderSpeechInput() {
            const isPronunciationMode = quizMode === 'pronunciation';
            const micButton = document.createElement('button');
            micButton.id = 'mic-button';
            micButton.className = 'w-full py-4 flex items-center justify-center bg-red-500 text-white text-xl font-bold rounded-xl shadow-lg hover:bg-red-600 transition duration-150';
            micButton.innerHTML = '<i class="fas fa-microphone mr-3"></i> Start Speaking';
            micButton.onclick = startListening;
            answerAreaEl.appendChild(micButton);

            const statusText = document.createElement('p');
            statusText.id = 'speech-status';
            statusText.className = 'text-center text-gray-600 mt-4 h-6';
            answerAreaEl.appendChild(statusText);

            // Display target text for Speaking modes to help user, but hide for Pronunciation (since it's already the prompt)
            if (!isPronunciationMode) {
                const targetTextContainer = document.createElement('div');
                targetTextContainer.className = 'mt-6 p-4 bg-gray-100 rounded-lg border-l-4 border-gray-300';
                targetTextContainer.innerHTML = `<p class="text-sm text-gray-700">**Target Answer (English):** <span class="font-bold">${currentQuestions[currentQuestionIndex].english}</span></p>`;
                answerAreaEl.appendChild(targetTextContainer);
            }
        }
        
        // --- Core Quiz Logic ---

        function startQuiz(level) {
            currentLevel = level;
            currentQuestionIndex = 0;
            score = 0;
            quizHistory = [];
            isAnswerLocked = false;

            // Determine question set based on mode
            if (['mc', 'typing'].includes(quizMode)) {
                currentQuestions = shuffleArray([...wordData[level]]).slice(0, 10);
            } else if (quizMode === 'pronunciation') {
                // For pronunciation, we use the sentences directly
                currentQuestions = shuffleArray([...pronunciationData[level]]).slice(0, 10);
            } else { // Speaking modes
                const direction = quizMode === 'speaking' ? 'forward' : 'reverse';
                currentQuestions = shuffleArray([...speakingData[direction][level]]).slice(0, 10);
            }

            levelSelectionEl.classList.add('hidden');
            resultsScreenEl.classList.add('hidden');
            quizScreenEl.classList.remove('hidden');
            renderQuizContent();
        }

        function checkAnswer(selectedOption) {
            if (isAnswerLocked) return;
            isAnswerLocked = true;
            
            const question = currentQuestions[currentQuestionIndex];
            const isCorrect = selectedOption === question.correct;
            
            // Highlight buttons
            document.querySelectorAll('.answer-button').forEach(button => {
                const isCorrectButton = button.textContent === question.correct;
                const isSelectedButton = button.textContent === selectedOption;

                if (isCorrectButton) {
                    button.classList.add('correct');
                    button.classList.remove('bg-white', 'hover:bg-gray-100');
                } else if (isSelectedButton) {
                    button.classList.add('incorrect');
                    button.classList.remove('bg-white', 'hover:bg-gray-100');
                } else {
                    button.disabled = true;
                }
            });

            recordResult(isCorrect, question.word, selectedOption, question.correct, 'Multiple Choice');

            if (isCorrect) {
                score++;
            }

            setTimeout(nextQuestion, 1500);
        }

        function checkTypingAnswer(userAnswer) {
            if (isAnswerLocked) return;
            isAnswerLocked = true;

            const question = currentQuestions[currentQuestionIndex];
            const normalizedUser = normalizeString(userAnswer);
            const normalizedCorrect = normalizeString(question.word); // Spanish word is the correct answer

            const isCorrect = normalizedUser === normalizedCorrect;
            const inputEl = document.getElementById('typing-input');
            const submitButton = answerAreaEl.querySelector('button');
            const skipButton = answerAreaEl.querySelector('button:last-child');
            
            inputEl.disabled = true;
            submitButton.disabled = true;
            skipButton.disabled = true;

            let resultText = '';
            if (isCorrect) {
                inputEl.classList.add('correct');
                score++;
                resultText = 'Correct!';
            } else {
                inputEl.classList.add('incorrect');
                resultText = `Incorrect. Correct answer was: "${question.word}"`;
            }

            // Display result
            const resultDiv = document.createElement('div');
            resultDiv.className = `mt-4 p-3 rounded-lg font-bold text-white ${isCorrect ? 'bg-green-500' : 'bg-red-500'}`;
            resultDiv.textContent = resultText;
            answerAreaEl.appendChild(resultDiv);


            recordResult(isCorrect, question.correct, userAnswer, question.word, 'Typing');

            setTimeout(nextQuestion, 2500);
        }

        // Handles the result of a speaking quiz mode (speaking/reverse-speaking/pronunciation)
        function checkSpeechAnswer(transcript) {
            if (isAnswerLocked) return;
            isAnswerLocked = true;

            const question = currentQuestions[currentQuestionIndex];
            const target = quizMode === 'pronunciation' ? question : question.spanish;
            const similarity = calculateSimilarity(target, transcript);
            const threshold = 70; // 70% word match threshold
            const isCorrect = similarity >= threshold;
            const feedbackColor = isCorrect ? 'bg-green-500' : 'bg-red-500';
            
            if (isCorrect) {
                score++;
            }

            const micButton = document.getElementById('mic-button');
            const statusText = document.getElementById('speech-status');
            micButton.disabled = true;
            micButton.classList.remove('listening', 'bg-red-500', 'hover:bg-red-600');
            micButton.classList.add('bg-gray-400');
            micButton.innerHTML = '<i class="fas fa-microphone-slash mr-3"></i> Finished';
            statusText.classList.remove('listening');

            // Display results
            let targetDisplay = quizMode === 'pronunciation' ? '' : `Expected: "${target}"`;

            const resultDiv = document.createElement('div');
            resultDiv.className = `mt-4 p-3 rounded-xl shadow-lg ${feedbackColor} text-white`;
            resultDiv.innerHTML = `
                <p class="font-bold text-xl">${isCorrect ? 'Correct!' : 'Incorrect.'}</p>
                <p>You said: **"${transcript || 'Nothing detected'}"**</p>
                ${quizMode === 'pronunciation' ? `<p>Target: **"${target}"**</p>` : ''}
                <p class="mt-2 text-sm">Similarity Score: ${similarity.toFixed(0)}% (Threshold: ${threshold}%)</p>
                ${targetDisplay && quizMode !== 'pronunciation' ? `<p class="mt-2 text-sm">${targetDisplay}</p>` : ''}
            `;
            answerAreaEl.appendChild(resultDiv);


            recordResult(isCorrect, target, transcript, target, 'Speaking/Pronunciation', similarity.toFixed(0));

            setTimeout(nextQuestion, 4000);
        }

        // --- Speaking/Listening Logic ---

        function startListening() {
            if (!recognition) {
                alert('Your browser does not support speech recognition. Please try the multiple choice or typing modes.');
                return;
            }

            const micButton = document.getElementById('mic-button');
            const statusText = document.getElementById('speech-status');
            
            // Reset previous state
            micButton.disabled = true;
            micButton.classList.add('listening');
            micButton.innerHTML = '<i class="fas fa-microphone mr-3"></i> Listening...';
            statusText.textContent = 'Speak now in Spanish.';

            recognition.start();

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                micButton.classList.remove('listening');
                statusText.textContent = `Processing: "${transcript}"`;
                recognition.stop();
                checkSpeechAnswer(transcript);
            };

            recognition.onerror = (event) => {
                micButton.classList.remove('listening');
                micButton.disabled = false;
                micButton.innerHTML = '<i class="fas fa-microphone mr-3"></i> Try Again';
                statusText.textContent = `Error: ${event.error}. Try again.`;
                recognition.stop();
            };
            
            recognition.onend = () => {
                if (!isAnswerLocked) {
                    micButton.disabled = false;
                    micButton.innerHTML = '<i class="fas fa-microphone mr-3"></i> Start Speaking';
                    statusText.textContent = 'Listening ended. Click to try again.';
                }
            };
        }

        // --- AI-Powered Speech Synthesis (Text-to-Speech) ---
        async function generateAudio(text) {
            const ttsButton = document.getElementById('tts-button');
            if (ttsButton) {
                ttsButton.disabled = true;
                ttsButton.innerHTML = '<i class="fas fa-spinner fa-spin text-xl"></i>';
            }

            // CORRECTED: Use a Netlify serverless function proxy to securely call the Gemini API
            const functionUrl = '/.netlify/functions/generate-tts-audio';

            try {
                const response = await fetch(functionUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        // Pass the necessary parameters to the serverless function
                        text_to_speak: `Say the following Spanish phrase as a Spanish language instructor: ${text}`,
                        model: 'gemini-2.5-flash-preview-tts',
                        voice: 'es-ES-Wavenet-D'
                    })
                });

                if (!response.ok) {
                    // Handle errors returned by the Netlify function
                    const errorData = await response.json();
                    console.error('TTS Function error:', errorData);
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                // Retrieve the base64 audio content from the serverless function's response
                const base64Audio = data.audioContent; 
                
                // Audio Playback Logic
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }

                const audioBuffer = base64ToArrayBuffer(base64Audio);

                audioContext.decodeAudioData(audioBuffer, (buffer) => {
                    const source = audioContext.createBufferSource();
                    source.buffer = buffer;
                    source.connect(audioContext.destination);
                    source.start(0);

                    source.onended = () => {
                        if (ttsButton) {
                            ttsButton.disabled = false;
                            ttsButton.innerHTML = '<i class="fas fa-volume-up text-xl"></i>';
                        }
                    };
                }, (e) => {
                    console.error("Error decoding audio data", e);
                    alert("Failed to play audio. Check console for details.");
                    if (ttsButton) {
                        ttsButton.disabled = false;
                        ttsButton.innerHTML = '<i class="fas fa-volume-up text-xl"></i>';
                    }
                });

            } catch (error) {
                console.error("TTS Fetch Error:", error);
                alert(`Error generating audio: ${error.message}`);
                if (ttsButton) {
                    ttsButton.disabled = false;
                    ttsButton.innerHTML = '<i class="fas fa-volume-up text-xl"></i>';
                }
            }
        }
        
        // Utility function to convert Base64 to ArrayBuffer
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        // --- Navigation and Results ---

        function recordResult(isCorrect, prompt, userAnswer, correctAnswer, type, similarity = null) {
            let questionPrompt = prompt;
            let answerDisplay = correctAnswer;

            // Adjust prompt/answer display for speaking modes
            if (['speaking', 'reverse-speaking'].includes(quizMode) && type === 'Speaking/Pronunciation') {
                questionPrompt = currentQuestions[currentQuestionIndex].question; // The prompt question
                answerDisplay = currentQuestions[currentQuestionIndex].spanish; // The target Spanish answer
            } else if (quizMode === 'typing' && type === 'Typing') {
                questionPrompt = currentQuestions[currentQuestionIndex].correct; // The English word
                answerDisplay = currentQuestions[currentQuestionIndex].word; // The Spanish word
            }

            quizHistory.push({
                index: currentQuestionIndex + 1,
                isCorrect,
                prompt: questionPrompt,
                target: answerDisplay,
                userAnswer: userAnswer,
                type: type,
                similarity: similarity
            });
        }

        function skipQuestion() {
            if (isAnswerLocked) return;
            isAnswerLocked = true;

            const question = currentQuestions[currentQuestionIndex];
            const prompt = ['mc', 'typing'].includes(quizMode) ? question.word : (quizMode === 'pronunciation' ? question : question.question);
            const target = ['mc', 'typing'].includes(quizMode) ? question.correct : (quizMode === 'pronunciation' ? question : question.spanish);
            
            recordResult(false, prompt, 'SKIPPED', target, 'Skipped');
            
            nextQuestion();
        }

        function nextQuestion() {
            currentQuestionIndex++;
            isAnswerLocked = false;

            if (currentQuestionIndex < currentQuestions.length) {
                renderQuizContent();
            } else {
                showResults();
            }
        }

        function showResults() {
            quizScreenEl.classList.add('hidden');
            resultsScreenEl.classList.remove('hidden');

            finalScoreEl.textContent = score;

            let message = '';
            if (score === 10) {
                message = 'Outstanding! You are fluent in this level. Â¡Felicidades!';
            } else if (score >= 7) {
                message = 'Great job! You have a solid understanding of this level.';
            } else if (score >= 4) {
                message = 'Good effort! Keep practicing to master this level.';
            } else {
                message = 'Practice makes perfect! Review the words you missed.';
            }
            scoreMessageEl.textContent = message;

            renderReviewList();
        }

        function renderReviewList() {
            reviewListEl.innerHTML = '';
            quizHistory.forEach(item => {
                const isSkipped = item.userAnswer === 'SKIPPED';
                let cardClass = '';
                let resultIcon = '';

                if (isSkipped) {
                    cardClass = 'review-skipped';
                    resultIcon = '<i class="fas fa-forward text-gray-500"></i> Skipped';
                } else if (item.isCorrect) {
                    cardClass = 'review-correct';
                    resultIcon = '<i class="fas fa-check-circle text-green-500"></i> Correct';
                } else {
                    cardClass = 'review-incorrect';
                    resultIcon = '<i class="fas fa-times-circle text-red-500"></i> Incorrect';
                }

                let answerDetails = '';

                if (item.type.includes('Speaking')) {
                    answerDetails = `
                        <p class="text-sm mt-1 text-gray-600">You Said: <span class="font-semibold">${item.userAnswer}</span></p>
                        <p class="text-sm text-gray-600">Target: <span class="font-semibold">${item.target}</span></p>
                        <p class="text-xs text-gray-500">Similarity: ${item.similarity}%</p>
                    `;
                } else if (item.type === 'Typing' || item.type === 'Multiple Choice') {
                    const userText = item.userAnswer || 'No Answer';
                    const targetText = item.target;
                    answerDetails = `
                        <p class="text-sm mt-1 text-gray-600">Your Answer: <span class="font-semibold">${userText}</span></p>
                        <p class="text-sm text-gray-600">Correct: <span class="font-semibold">${targetText}</span></p>
                    `;
                } else if (isSkipped) {
                     answerDetails = `<p class="text-sm mt-1 text-gray-600">Correct Answer: <span class="font-semibold">${item.target}</span></p>`;
                }


                const reviewCard = document.createElement('div');
                reviewCard.className = `p-4 mb-3 bg-white rounded-lg shadow-md ${cardClass}`;
                reviewCard.innerHTML = `
                    <div class="flex justify-between items-start">
                        <p class="text-lg font-bold text-gray-800">Q${item.index}: ${item.prompt}</p>
                        <span class="text-sm font-semibold">${resultIcon}</span>
                    </div>
                    ${answerDetails}
                `;
                reviewListEl.appendChild(reviewCard);
            });
        }

        function copyReviewToClipboard(button) {
            const reviewText = quizHistory.map(item => {
                let status = item.isCorrect ? 'Correct' : (item.userAnswer === 'SKIPPED' ? 'Skipped' : 'Incorrect');
                let details = '';

                if (item.type.includes('Speaking')) {
                    details = `\n  Target: ${item.target}\n  You Said: ${item.userAnswer}\n  Similarity: ${item.similarity}%`;
                } else if (item.userAnswer === 'SKIPPED') {
                    details = `\n  Correct Answer: ${item.target}`;
                } else {
                    details = `\n  Correct Answer: ${item.target}\n  Your Answer: ${item.userAnswer}`;
                }

                return `Q${item.index} [${status}] (${item.type})\nPrompt: ${item.prompt}${details}\n---`;
            }).join('\n');

            const fullText = `--- Spanish Language Trainer Quiz Results (${currentLevel.toUpperCase()}) ---\nScore: ${score}/10\n\n${reviewText}`;

            const textarea = document.createElement('textarea');
            textarea.value = fullText;
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                document.execCommand('copy');
                button.innerHTML = '<i class="fas fa-check"></i> Copied!';
                button.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                button.classList.add('bg-green-500', 'hover:bg-green-600');

                setTimeout(() => {
                    button.innerHTML = '<i class="fas fa-clipboard"></i> Copy Review to Clipboard';
                    button.classList.remove('bg-green-500', 'hover:bg-green-600');
                    button.classList.add('bg-blue-500', 'hover:bg-blue-600');
                }, 2000);
            } catch (err) {
                console.error('Could not copy text: ', err);
                button.innerHTML = '<i class="fas fa-times"></i> Failed to copy!';
            }
            
            document.body.removeChild(textarea);
        }

        function resetQuiz() {
            currentLevel = null;
            currentQuestions = [];
            currentQuestionIndex = 0;
            score = 0;
            isAnswerLocked = false;
            quizHistory = []; 
            
            // Default back to MC and visually update the mode buttons
            setQuizMode('mc'); 

            resultsScreenEl.classList.add('hidden');
            quizScreenEl.classList.add('hidden');
            levelSelectionEl.classList.remove('hidden');
            reviewListEl.innerHTML = ''; 
        }
        
        // --- Initialization ---
        window.onload = initializeLevelButtons;

    </script>
</body>
</html>
